# ğŸ—ï¸ MCP Gateway - Architecture

## Vue d'ensemble

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    INTERNET                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ğŸ‘¤ MCP CLIENT (Postman)                                 â”‚
â”‚                                                                                      â”‚
â”‚  1ï¸âƒ£ Demande un token OAuth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  2ï¸âƒ£ Appelle /mcp/weather ou /mcp/calculator avec Bearer token                â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                                                          â”‚
                    â”‚ HTTPS :443                                               â”‚ HTTP :8080
                    â–¼                                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ğŸšª API GATEWAY (Traefik)              â”‚    â”‚   ğŸ” AUTHORIZATION SERVER    â”‚
â”‚                  :443                            â”‚    â”‚       (Keycloak)             â”‚
â”‚                                                  â”‚    â”‚          :8080               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚                              â”‚
â”‚  â”‚           ENTRYPOINTS                       â”‚ â”‚    â”‚  â€¢ OAuth 2.0 / OIDC         â”‚
â”‚  â”‚  â€¢ :80 (HTTP â†’ HTTPS redirect)             â”‚ â”‚    â”‚  â€¢ Token endpoint           â”‚
â”‚  â”‚  â€¢ :443 (HTTPS - TLS termination)          â”‚ â”‚    â”‚  â€¢ Introspection endpoint   â”‚
â”‚  â”‚  â€¢ :8081 (Dashboard)                       â”‚ â”‚    â”‚  â€¢ JWKS endpoint            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚                              â”‚
â”‚                      â”‚                          â”‚    â”‚  Realm: mcp-gateway          â”‚
â”‚                      â–¼                          â”‚    â”‚  Clients:                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚   â€¢ mcp-client (public)     â”‚
â”‚  â”‚           MIDDLEWARES                       â”‚ â”‚    â”‚   â€¢ api-gateway (confid.)  â”‚
â”‚  â”‚                                             â”‚ â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚  1. oauth-auth (ForwardAuth) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  2. rate-limit (100 req/min)               â”‚ â”‚              â”‚
â”‚  â”‚  3. security-headers (XSS, HSTS...)        â”‚ â”‚              â–¼
â”‚  â”‚  4. strip-prefix (/mcp/weather â†’ /)        â”‚ â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚    ğŸ›¡ï¸ AUTH SERVICE (Flask)   â”‚
â”‚                      â”‚                          â”‚    â”‚          :3000               â”‚
â”‚                      â–¼                          â”‚    â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚  /verify                     â”‚
â”‚  â”‚           ROUTERS                           â”‚ â”‚    â”‚   â€¢ Extrait Bearer token    â”‚
â”‚  â”‚                                             â”‚ â”‚    â”‚   â€¢ Appelle Keycloak        â”‚
â”‚  â”‚  /mcp/weather    â†’ mcp-weather-service     â”‚ â”‚    â”‚     introspection           â”‚
â”‚  â”‚  /mcp/calculator â†’ mcp-calculator-service  â”‚ â”‚    â”‚   â€¢ Retourne headers:       â”‚
â”‚  â”‚  /health         â†’ health-service          â”‚ â”‚    â”‚     X-User-Sub              â”‚
â”‚  â”‚  /.well-known/*  â†’ oauth-discovery-service â”‚ â”‚    â”‚     X-User-Email            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚     X-User-Scopes           â”‚
â”‚                      â”‚                          â”‚    â”‚                              â”‚
â”‚                      â”‚                          â”‚    â”‚  401 + WWW-Authenticate     â”‚
â”‚                      â”‚                          â”‚    â”‚  si token invalide          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                         â”‚
          â–¼ mTLS (HTTPS)            â–¼ HTTP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸŒ¤ï¸ MCP WEATHER SERVER  â”‚  â”‚  ğŸ§® MCP CALCULATOR      â”‚
â”‚        :8000             â”‚  â”‚        :8001            â”‚
â”‚                          â”‚  â”‚                         â”‚
â”‚  Protocol: JSON-RPC 2.0  â”‚  â”‚  Protocol: JSON-RPC 2.0 â”‚
â”‚  Transport: HTTPS/mTLS   â”‚  â”‚  Transport: HTTP        â”‚
â”‚                          â”‚  â”‚                         â”‚
â”‚  Tools:                  â”‚  â”‚  Tools:                 â”‚
â”‚  â€¢ get_weather_forecast  â”‚  â”‚  â€¢ add                  â”‚
â”‚  â€¢ get_weather_alerts    â”‚  â”‚  â€¢ subtract             â”‚
â”‚  â€¢ get_uv_index          â”‚  â”‚  â€¢ multiply             â”‚
â”‚                          â”‚  â”‚  â€¢ divide               â”‚
â”‚  VÃ©rifie X-User-Scopes   â”‚  â”‚  â€¢ power                â”‚
â”‚  pour autorisation       â”‚  â”‚  â€¢ sqrt                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Flux OAuth 2.0 Complet

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚     â”‚ Traefik  â”‚     â”‚  Auth    â”‚     â”‚ Keycloak â”‚     â”‚   MCP    â”‚
â”‚ (Postman)â”‚     â”‚ Gateway  â”‚     â”‚ Service  â”‚     â”‚          â”‚     â”‚  Server  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚ 1. POST /token â”‚                â”‚                â”‚                â”‚
     â”‚ (grant_type=   â”‚                â”‚                â”‚                â”‚
     â”‚  authorization_code)            â”‚                â”‚                â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚ 2. access_tokenâ”‚                â”‚                â”‚                â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚ 3. POST /mcp/weather            â”‚                â”‚                â”‚
     â”‚    Authorization: Bearer xxx    â”‚                â”‚                â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚ 4. ForwardAuth â”‚                â”‚                â”‚
     â”‚                â”‚    /verify     â”‚                â”‚                â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚ 5. POST        â”‚                â”‚
     â”‚                â”‚                â”‚    /introspect â”‚                â”‚
     â”‚                â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚ 6. {active:    â”‚                â”‚
     â”‚                â”‚                â”‚     true, ...} â”‚                â”‚
     â”‚                â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚ 7. 200 OK      â”‚                â”‚                â”‚
     â”‚                â”‚    X-User-Sub  â”‚                â”‚                â”‚
     â”‚                â”‚    X-User-Scopes                â”‚                â”‚
     â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚ 8. POST / (mTLS)                â”‚                â”‚
     â”‚                â”‚    + X-User-* headers           â”‚                â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚ 9. JSON-RPC Response            â”‚                â”‚
     â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚ 10. Response   â”‚                â”‚                â”‚                â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
```

## ğŸ” mTLS (Mutual TLS) - DÃ©tail

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CERTIFICATS                                     â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚   ğŸ›ï¸ CA (Root)   â”‚  ca.crt / ca.key                                      â”‚
â”‚  â”‚   MCP-Gateway-CA â”‚  Auto-signÃ©, fait confiance Ã  tous                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â”‚ Signe                                                           â”‚
â”‚           â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚                                                                  â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚        â”‚
â”‚  â”‚  â”‚ ğŸšª gateway.crt/key   â”‚         â”‚ ğŸŒ¤ï¸ mcp-weather.crt  â”‚        â”‚        â”‚
â”‚  â”‚  â”‚                      â”‚         â”‚    /key             â”‚        â”‚        â”‚
â”‚  â”‚  â”‚ CN=gateway           â”‚         â”‚ CN=mcp-weather      â”‚        â”‚        â”‚
â”‚  â”‚  â”‚ SAN: localhost,      â”‚         â”‚ SAN: mcp-weather,   â”‚        â”‚        â”‚
â”‚  â”‚  â”‚      traefik         â”‚         â”‚      localhost      â”‚        â”‚        â”‚
â”‚  â”‚  â”‚                      â”‚         â”‚                     â”‚        â”‚        â”‚
â”‚  â”‚  â”‚ UtilisÃ© par Traefik  â”‚         â”‚ UtilisÃ© par MCP     â”‚        â”‚        â”‚
â”‚  â”‚  â”‚ comme CLIENT cert    â”‚         â”‚ comme SERVER cert   â”‚        â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚        â”‚
â”‚  â”‚             â”‚                                â”‚                   â”‚        â”‚
â”‚  â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ mTLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚        â”‚
â”‚  â”‚                                                                  â”‚        â”‚
â”‚  â”‚    Traefik prÃ©sente gateway.crt â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ MCP vÃ©rifie vs CA    â”‚        â”‚
â”‚  â”‚    MCP prÃ©sente mcp-weather.crt â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Traefik vÃ©rifie vs CAâ”‚        â”‚
â”‚  â”‚                                                                  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ Structure du Projet

```
gateway/
â”œâ”€â”€ ğŸ“„ docker-compose.yml          # Orchestration des services
â”œâ”€â”€ ğŸ“„ README.md                   # Documentation
â”œâ”€â”€ ğŸ“„ ARCHITECTURE.md             # Ce fichier
â”‚
â”œâ”€â”€ ğŸ“ certs/                      # Certificats mTLS
â”‚   â”œâ”€â”€ ca.crt                     # CA root certificate
â”‚   â”œâ”€â”€ ca.key                     # CA private key
â”‚   â”œâ”€â”€ gateway.crt                # Traefik client cert
â”‚   â”œâ”€â”€ gateway.key                # Traefik client key
â”‚   â”œâ”€â”€ mcp-weather.crt            # MCP server cert
â”‚   â””â”€â”€ mcp-weather.key            # MCP server key
â”‚
â”œâ”€â”€ ğŸ“ traefik/                    # Configuration Traefik
â”‚   â”œâ”€â”€ traefik.yml                # Config statique
â”‚   â””â”€â”€ dynamic/
â”‚       â”œâ”€â”€ http.yml               # Routes, middlewares, services
â”‚       â””â”€â”€ tls.yml                # Config TLS
â”‚
â”œâ”€â”€ ğŸ“ auth-service/               # Service de validation OAuth
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ auth_service.py            # Flask app
â”‚
â”œâ”€â”€ ğŸ“ mcp-weather-server/         # Serveur MCP MÃ©tÃ©o
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ weather_server.py          # FastAPI + JSON-RPC
â”‚
â”œâ”€â”€ ğŸ“ mcp-calculator-server/      # Serveur MCP Calculatrice
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ calculator_server.py       # FastAPI + JSON-RPC
â”‚
â”œâ”€â”€ ğŸ“ keycloak/                   # Configuration Keycloak
â”‚   â””â”€â”€ realm-export.json          # Realm prÃ©-configurÃ©
â”‚
â””â”€â”€ ğŸ“ postman/                    # Collection Postman
    â””â”€â”€ MCP-Gateway.postman_collection.json
```

## ğŸŒ Endpoints

| Endpoint | Port | Description |
|----------|------|-------------|
| `https://localhost/mcp/weather` | 443 | API MCP MÃ©tÃ©o (OAuth requis) |
| `https://localhost/mcp/calculator` | 443 | API MCP Calculatrice (OAuth requis) |
| `https://localhost/health` | 443 | Health check |
| `http://localhost:8080` | 8080 | Keycloak Admin Console |
| `http://localhost:8081` | 8081 | Traefik Dashboard |

## ğŸ”‘ Credentials par dÃ©faut

| Service | Username | Password |
|---------|----------|----------|
| Keycloak Admin | admin | admin |
| Test User | testuser | testpassword123 |
| API Gateway Client | api-gateway | api-gateway-secret-change-me |

---

## Diagramme Mermaid (pour rendu graphique)

```mermaid
flowchart TB
    subgraph Internet
        Client[ğŸ‘¤ MCP Client<br/>Postman]
    end

    subgraph Gateway["ğŸšª API Gateway (Traefik :443)"]
        EP[Entrypoints<br/>:80, :443, :8081]
        MW[Middlewares<br/>oauth-auth, rate-limit<br/>security-headers]
        RT[Routers<br/>/mcp/weather<br/>/mcp/calculator]
    end

    subgraph Auth["ğŸ” Authorization"]
        KC[Keycloak<br/>:8080<br/>OAuth 2.0 / OIDC]
        AS[Auth Service<br/>:3000<br/>Token Introspection]
    end

    subgraph MCP["ğŸ–¥ï¸ MCP Servers"]
        Weather[ğŸŒ¤ï¸ Weather Server<br/>:8000<br/>mTLS]
        Calc[ğŸ§® Calculator Server<br/>:8001<br/>HTTP]
    end

    Client -->|1. Get Token| KC
    KC -->|2. Access Token| Client
    Client -->|3. API Request + Bearer| EP
    EP --> MW
    MW -->|4. ForwardAuth| AS
    AS -->|5. Introspect| KC
    KC -->|6. Token Info| AS
    AS -->|7. X-User-* Headers| MW
    MW --> RT
    RT -->|8. mTLS| Weather
    RT -->|8. HTTP| Calc
    Weather -->|9. Response| RT
    Calc -->|9. Response| RT
    RT -->|10. Response| Client

    style Gateway fill:#e1f5fe
    style Auth fill:#fff3e0
    style MCP fill:#e8f5e9
```
